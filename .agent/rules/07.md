---
trigger: always_on
---

# Clipboard Brain — Platform Channels Specification

## 1. Purpose of This Document

This document defines:

- How Flutter communicates with native macOS code.
- Channel names and responsibilities.
- Message formats and payload schemas.
- Error handling rules.
- Threading and lifecycle rules.

All native communication must strictly follow this contract.

---

---

## 2. Channel Architecture Overview

Only one bridge service exists in Flutter:

```

Infrastructure
└── NativeBridgeService
├── MethodChannel
└── EventChannel
↓
ClipboardBrainPlugin.swift

```

No other part of the app may communicate with native code directly.

---

---

## 3. Channel Names (Constants)

All channel names must be constants and never duplicated.

```dart
const String kNativeMethodChannel = 'clipboard_brain/methods';
const String kNativeEventChannel  = 'clipboard_brain/events';
```

---

---

## 4. Supported Native Capabilities (MVP)

Native plugin must provide:

1. Clipboard change listening
2. Clipboard read access
3. Clipboard permissions validation
4. App background behavior support
5. Menu bar integration hooks (optional MVP)

---

---

## 5. EventChannel — Clipboard Events

### Event Name

`clipboardChanged`

### Payload Schema

```json
{
  "type": "text | image | files",
  "text": "string | null",
  "imagePath": "string | null",
  "filePaths": ["string"] | null,
  "timestamp": "ISO-8601 string"
}
```

### Rules

- Exactly one content field must be non-null.
- Payload must be JSON-serializable.
- Native must debounce duplicate clipboard events.
- Native must emit events off the main thread safely.

---

---

## 6. MethodChannel — Supported Methods

### 6.1 getClipboardSnapshot

Returns current clipboard content.

```json
Request: {}
Response:
{
  "type": "text | image | files",
  "text": "...",
  "imagePath": "...",
  "filePaths": [...],
  "timestamp": "ISO-8601 string"
}
```

---

---

### 6.2 startClipboardListener

Starts background clipboard monitoring.

```json
Request: {}
Response: { "started": true }
```

---

---

### 6.3 stopClipboardListener

Stops clipboard monitoring.

```json
Request: {}
Response: { "stopped": true }
```

---

---

### 6.4 requestPermissions

Validates clipboard access permissions.

```json
Request: {}
Response:
{
  "granted": true | false
}
```

---

---

## 7. Error Handling Contract

Native errors must be returned as:

```dart
PlatformException(
  code: "ERROR_CODE",
  message: "Human readable message",
  details: optional
)
```

Flutter must:

- Catch PlatformException.
- Convert into domain-safe error objects.
- Never crash UI.

---

---

## 8. Threading Rules

Native code must:

- Never block main thread.
- Dispatch clipboard monitoring on background queue.
- Marshal results back safely.

Flutter must:

- Treat all native calls as async.

---

---

## 9. Lifecycle Rules

- Clipboard listener starts when app launches.
- Stops when app exits or disabled by user.
- Must survive window close (menu bar mode).

---

---

## 10. Security Rules

- No network calls from native plugin.
- No data persistence in native layer.
- Clipboard data passed only to Flutter layer.

---

---

## 11. Versioning Strategy

- Channel contracts must remain backward compatible.
- New methods require documentation updates.

---

---

## 12. Forbidden

❌ Multiple MethodChannels
❌ Dynamic channel names
❌ Passing raw native objects
❌ UI calling platform channels
❌ Blocking native main thread

---

---

## 13. Change Policy

Platform channel changes require approval.
